Infectious Diseases in Germany by Stefan Borchardt
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

library(ggplot2)
library(ggthemes)
library(colorspace)
library(gridExtra)
library(tidyr)
library(dplyr)
library(reshape2)
library(lubridate)
library(parallel)
library(hts)
library(season)
library(forecast)
library(ggfortify)

```

# Univariate Plots Section
## Iteration 1

```{r echo=FALSE, Load_the_Data}
# Load the Data
#getwd()
#setwd("R Scripts/p4")


read_tidy_join <- function (filename, to_join) {
  # read tab-delimited CSV containing nuls
  # and join to other (previously read) dataframe
  rd <- read.delim2(paste(filename, "csv", sep="."), skipNul = T)
  # tidy
  td <- gather(rd, age, incidence, `A00..00`:`A80.` )
  colnames(td)[1] <- "date"
  colnames(td)[3] <- filename
  # strptime ignores week number, approximate date by adding days from Jan 1st
  jan <- as.Date(paste("01/01/", substr(td$date, 1, 4), sep=""), "%m/%d/%Y")
  td$date <- jan + (as.integer(substr(td$date, 8, 9)) - 1) * 7
  if (missing(to_join)) {
    return(td)
  }
  # join (on composite key) to ensure values for all dates x diseases
  jd <- full_join(to_join, td, by=c("date"="date", "age"="age"))
  jd[is.na(jd)] <- 0.0
  return(jd)
}

# combining seperate files into one dataset
c <- read_tidy_join("campylobacter")
ec <- read_tidy_join("ecoli", c)
eh <- read_tidy_join("ehec", ec)
g <- read_tidy_join("giardia", eh)
h <- read_tidy_join("hus", g)
i <- read_tidy_join("influenza", h)
l <- read_tidy_join("legionella", i)
m <- read_tidy_join("meningokokken", l)
n <- read_tidy_join("norovirus", m)
r <- read_tidy_join("rotavirus", n)
sa <- read_tidy_join("salmonella", r)
sh <- read_tidy_join("shigella", sa)
t <- read_tidy_join("typhus", sh)
incidences <- read_tidy_join("yersiniosis", t)
remove(c, ec, eh, g, h, i, l, m, n, r, sa, sh, t)

# tidy combined dataset 
long_inc <- gather(incidences, disease, incidence, campylobacter:yersiniosis)
wide_inc <- dcast(long_inc, date ~ age + disease)


```

I use data on infectious diseases which is collected by the Robert Koch Institute in Germany as a official statistic. From various customizable selections available, I chose the incidence of 14 diseases which can cause stomach flu or diarrhea, with the help of a doctor. My idea is that patient's characteristics can help to point out the most likely causes of similar symptoms.

Because I selected which data to include through the interface at https://survstat.rki.de , I already have some understanding of the structure of the data. On the other hand, because I did the data wrangling myself, I have to check that joins and value transformations worked as intended.

At first, I display some textual summaries:

```{r echo=FALSE, Univariate_Plots}

# basic information
str(incidences)
summary(incidences)
levels(incidences$age)
```

The factor age is not evenly spaced, young people have finer granularity. 

To see if my data wrangling is plausible I use the library hts to plot a grouped time series:

```{r echo=FALSE, fig.width=10, fig.height=10, Univariate_Plots1}
# convert to time series, therefore remove date
tsinc <- ts(subset(wide_inc, select= -date), frequency=52, start=2001)
# data can be grouped by age and disease, prepare description
grpdescr <- rbind(rep(levels(long_inc$age), 14), rep(levels(long_inc$disease), 16))
rownames(grpdescr) <- c("Age", "Disease")
# create grouped time series
gtsinc <- gts(tsinc, groups=grpdescr)
plot(gtsinc, levels=c(1, 2), labels=F)

```

Some age groups seem to be more prone to these infectious diseases and there are seasonal patterns.

# Univariate Analysis
## Iteration 1
### What is the structure of your dataset?

The incidence of the diseases, as cases per 100,000, is reported by week number of the last 15 years and by age group of the patients. After combining 14 separate files, the dataset contains 12,416 observations of 16 variables: The incidence of the 14 diseases for each week and age group. I filled in zeros where necessary, so that all age groups and diseases are present at any week to help analyzing time series at later stages.
The patient's age is included in groups of each year for small children, groups of five years for persons from 5 to 29 years and 10-year groups for ages 30 to 79. People over 80 years are the last group. 

### What is/are the main feature(s) of interest in your dataset?

I'd like to know, when a patient sees a doctor with gastrointestinal symptoms, what are the most likely infectious diseases to check. From a first look, a couple of the diseases have a maximum incidence lower than 1 per 100,000, but norovirus, salmonella and campylobacter have medians above 1 per 100,000. 

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

I assume the age of the patient and the time of the year to be other important factors. For a first glimpse, I plotted the dataset as a time series using hts, which revealed a seasonal pattern for some diseases and differences between the age groups. 

### Did you create any new variables from existing variables in the dataset?

No, existing values were transformed only.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

The interface I had to extract the data from, SurvStat@RKI 2.0  https://survstat.rki.de , allows to download only two dimensions at once, for which I chose patient age group and the week. The 14 data files typically had 16 columns and 731 rows each. I combined these files into one by joining the separate data frames after I had changed the data format of some columns. Finally, I melted the combined data into one set of 12,416 observations of 16 variables.

# Univariate Plots Section
## Iteration 2

The first look at the data was so promising, that I decided to increase the number of variables I take into consideration. Unfortunately, the limitations of the interface required to download a total of 72 files to additionally include gender and region of the patients. I removed the five most rare diseases of iteration 1.

```{r eval = FALSE, echo=FALSE, Load_the_Data2}
# Load the Data
####################################################################################
#########  switch to eval = TRUE if you want to read 'raw' files again #############
#########  otherwise see next chunk                                    #############
####################################################################################

#getwd()
#setwd("R Scripts/p4")


read_join <- function (region, gender, file, disease, to_join) {
  # Reads one csv file and joins it to data from other file
  # Args: 
  #   region, gender, file - for filename and path
  #   disease - label for disease
  #   to_join - optional, data.frame from previous file
  # Returns:
  #   read (and joined) data frame    

  # read tab-delimited CSV containing nuls
  filename <- paste(paste(paste(region, gender, sep="\\"), file, sep="\\"), "csv", sep=".")
  rd <- read.delim2(filename, skipNul = T)
  # reformat age column names
  colnames(rd)[2:ncol(rd)] <- gsub(pattern="\\..*", replacement="",
                                   x=colnames(rd)[2:ncol(rd)])
  # melt age columns
  td <- gather(rd, age, incidence, `A00`:`A80` )
  colnames(td)[1] <- "date"
  colnames(td)[3] <- disease
  # strptime ignores week number, approximate date by adding days from Jan 1st
  jan <- as.Date(paste("01/01/", substr(td$date, 1, 4), sep=""), "%m/%d/%Y")
  # and keep week number for seasonal analysis
  td$week <- as.integer(substr(td$date, 8, 9))
  td$date <- jan + (td$week - 1) * 7
  
  if (missing(to_join)) {
    return(td)
  }
  # join on composite key
  # necessary to do that here on small tables due to memory limitations
  jd <- full_join(to_join, td, by=c("date"="date", "age"="age", "week"="week"))
  jd[is.na(jd)] <- 0.0
  return(jd)
}

read_disease <- function (region, gender) {
  # Reads csv files for all diseases
  # Args: 
  #   region, gender - for filepath
  # Returns:
  #   read data frame with diseases as columns 
  
  # handle files for the diseases
  c <- read_join(region, gender, "campylobacter", "camp")
  ec <- read_join(region, gender, "ecoli", "ecol", c)
  eh <- read_join(region, gender, "ehec", "ehec", ec)
  g <- read_join(region, gender, "giardia", "giar", eh)
  i <- read_join(region, gender, "influenza", "infl", g)
  n <- read_join(region, gender, "norovirus", "noro", i)
  r <- read_join(region, gender, "rotavirus", "rota", n)
  s <- read_join(region, gender, "salmonella", "salm", r)
  return(read_join(region, gender, "yersiniosis", "yers", s))
}

read_genders <- function (region) {
  # Reads csv files for both genders
  # Args: 
  #   region - for filepath
  # Returns:
  #   read data frame with gender as factor
  
  female <- read_disease(region, "female")
  female$gender <- "fem"
  male <- read_disease(region, "male")
  male$gender <- "mal"
  jd <- bind_rows(female, male)
  jd$gender <- as.factor(jd$gender)
  return(jd)
}

read_region <- function (region, to_bind) {
  # Reads csv files for one region and bind to data of other region
  # Args: 
  #   region - for filepath
  #   to_bind - optional, data.frame from previous region
  # Returns:
  #   read data frame (bound to previous region)
  
  rd <- read_genders(region)
  rd$region <- region
  if (missing(to_bind)) {
    return(rd)
  }
  return(bind_rows(to_bind, rd))
}

# ------------------
# read the files and combine to one dataset
rd_north <- read_region("n")
rd_ne <- read_region("e", rd_north)
rd_nes <- read_region("s", rd_ne)
incidences <- read_region("w", rd_nes)
remove(rd_north, rd_ne, rd_nes)
incidences$region <- as.factor(incidences$region)
incidences <- arrange(incidences, date)

write.csv(incidences, file="incidences.csv", row.names=F)

# tidy combined dataset 
# Long variant used for creating the wide format necessary for the
# time series plot. 
# I'm interested in which diseases are most likely 
# for the patient and reducing them to a single factor does
# not seem appropriate
long_inc <- gather(incidences, disease, incidence, camp, ecol, ehec, giar, infl, noro, rota, salm, yers)
wide_inc <- dcast(long_inc, date ~ disease + age + gender + region)

```

```{r echo=FALSE, fig.width=10, fig.height=7, message=FALSE, warning=FALSE, Load_the_Data3}
#getwd()
#setwd("R Scripts/p4")
####################################################################################
#########  read data converted above                                   #############
####################################################################################
# load prepared data
incidences <- read.csv("incidences.csv")
incidences$date <- as.Date(incidences$date, "%Y-%m-%d")
incidences <- arrange(incidences, date)
# remove redundant week column for recasting
long_inc <- gather(subset(incidences, select=-week), disease, incidence, camp: yers)
wide_inc <- dcast(long_inc, date ~ disease + age + gender + region)
```

Again, I check the structure and get an overview:

```{r echo=FALSE, fig.width=10, fig.height=7, Univariate_Plots2}

# basic information
str(incidences)
summary(incidences)

```

Also, I plot a time series to see that the data wrangling worked. 

```{r echo=FALSE, fig.width=10, fig.height=7, Univariate_Plots3}
# convert to time series, therefore remove date
tsinc <- ts(subset(wide_inc, select= -date), frequency=52, start=2001)
# create grouped time series, 'characters' explain how column labels translate to groups
gtsinc <- gts(tsinc, characters=list(5, 4, 4, 1), gnames=c(
  "Disease", "Age", "Gender", "Region", 
  "Disease+Age", "Disease+Gender", "Disease+Region", 
  "Age+Gender", "Age+Region", 
  "Gender+Region"))
plot(gtsinc, levels=c(1, 2), labels=F)
plot(gtsinc, levels=c(3, 4), labels=F)

```

Same as before, only adding gender is a bit disappointing. But there are differences between the regions.

A look into the distribution of incidences, also experimenting on equidistant breaks on log scale:

```{r echo=FALSE, fig.width=10, fig.height=5, warning=FALSE, Univariate_Plots4}

theme_set(theme_few())

# histograms of incidences
qplot(data=long_inc, x=incidence, geom="histogram", main="Plain Histogram of Incidences") 
qplot(data=long_inc, x=incidence, geom="histogram", binwidth=0.3, main="Adjusted Binwidth")
# trying to space breaks evenly
ggplot(data=long_inc, aes(x=incidence)) + geom_histogram(binwidth=0.3) +
  scale_x_log10(breaks=c(rev(round(exp(-seq(from=0.1, to=5, length.out=10)), digits=2)),
                         round(exp(seq(from=0.5, to=6, length.out=10)), digits=2))) +
  labs(title = "Logarithmic Incidence")
```

At first I was suprised that the occurence of diseases seemed evenly distributed over all ages, then I recoded the factor levels:

```{r echo=FALSE, fig.width=10, fig.height=5, Univariate_Plots5}
# histogram of ages
qplot(data=subset(long_inc, incidence>0), x=age, geom="bar", main="Plain Histogram of Ages") 

long_inc$age_eqdist <- long_inc$age
# recode levels into bins of 10 years
levels(long_inc$age_eqdist) <- c(rep("A00", 6), "A10", "A10", "A20", "A20", "A30", "A40", "A50", "A60", "A70", "A80")
qplot(data=subset(long_inc, incidence>0), x=age_eqdist, geom="bar", 
      main="Adjusted Factor Levels of Ages ") 
long_inc$age_eqdist <- NULL
```

Kids are more prone to infectious diseases it seems. 

It is hard to compare regions by number of disease occurences, so I gradually increased the threshold with the help of the incidence histogram from above:

```{r echo=FALSE, fig.width=10, fig.height=7, Univariate_Plots6}

pl <- function (inc) {
  # plots a histogram of regions
  return(qplot(data=subset(long_inc, incidence>inc), x=region, geom="bar", fill=region,
               main=paste("Regions with Incidence > ", inc, sep="")) + 
           guides(fill=FALSE) 
         )
}

grid.arrange(pl(0), pl(1), pl(10), pl(100))
```

High incidences seem to occur more often in the East.

I use the same approach with the diseases:

```{r echo=FALSE, fig.width=10, fig.height=7, Univariate_Plots7}

pl <- function (inc) {
  # plots a histogram of diseases
  return(
    qplot(data=subset(long_inc, incidence>inc), x=disease, geom="bar", fill=disease,
          main=paste("Diseases with Incidence > ", inc, sep="")) + 
      guides(fill=FALSE)
  )
}

grid.arrange(pl(0), pl(1), pl(10), pl(100))
```

I got the impression that only 3-5 diseases reach high incidences, so I will have a look at the variability later in the bivariate section.

I remember seasonal patterns from the initial time series plot. So this time I group by week of the year:

```{r echo=FALSE, fig.width=10, fig.height=7, Univariate_Plots8}

# include week number for seasonal plot instead of date
long_byweek <- gather(subset(incidences, select=-date), disease, incidence,
                      camp, ecol, ehec, giar, infl, noro, rota, salm, yers)

# histogram of diseases
pl <- function (inc) {
  return(
    qplot(data=subset(long_byweek, incidence>inc), x=week, 
          geom="histogram", binwidth=1, color=disease,
          main=paste("Diseases with Incidence > ", inc, sep="")) + 
      guides(color = guide_legend(reverse = TRUE))
  )
}

grid.arrange(pl(0), pl(5), pl(100), ncol=2)
```

Because the data is current (updated every Wednesday) I have to consider that values for December are still lower at this time. The numbers seem to show that the media attention that influenza usually gets should actually be on rotavirus and norovirus. Salmonella and campylobacter have a moderate high in summer, but much higher incidences can be seen for the two viruses in winter and spring.

Are there long-term trends? I resample the time series as quarterly and yearly values for the disease incidences in order to smooth:

```{r echo=FALSE, fig.width=10, fig.height=7, Univariate_Plots9}


pl <- function (deltat) {
  # resample and plot the time series for diseases
  
  # resample 
  w1 <- window.gts(gtsinc, deltat=deltat)
  # extract disease time series only
  w1ts <- aggts(w1, levels=c(1))
  # fix disease names (a little)
  colnames(w1ts) <- gsub(pattern="^.*/", replacement="", x=colnames(w1ts))
  # actually better than plotting colored lines as a time series plot would do
  plot(w1ts, type="b", main="Resampled Disease Incidences")
}

pl(0.25)
pl(1)

```

Norovirus is on the rise while rotavirus infections are declining. Immunization shots against rotavirus have been available since 2006 and became officially recommended (and paid for) in 2013. 

I have to consider that these are the cases that were reported to the Robert Koch Institute. The inclination to report the incidents might be influenced by, for instance, the amount of paperwork required (2 pages) or the awareness or diagnostic capabilities of the doctors.

I tried to find additional data sources about incidences of gastroenteritis from a health insurance. It contains the cases diagnosed as non-infectious gastroenteritis which caused sick leaves in the year 2005. That is the only year where data for memberships is available, so that I can approximate the incidence for the total population:

```{r echo=FALSE, fig.width=10, fig.height=5, Univariate_Plots10}
# data for gastroenteritis of one health insurance (AOK) for the years 2002-2008
aok_inc <- read.csv2("IND683_1.csv")
colnames(aok_inc)[2: ncol(aok_inc)] <- gsub(pattern = "X\\.", replacement = "",
                                   x = colnames(aok_inc)[2: ncol(aok_inc)])
aok_inc <- as.data.frame(t(aok_inc), stringsAsFactors = F)
colnames(aok_inc) <- aok_inc[1, ]
aok_inc$year <- rownames(aok_inc)
aok_inc <- aok_inc[-1, ]

# extract yearly disease time series only
w1 <- window.gts(gtsinc, deltat=1)
w1ts <- aggts(w1, levels=c(0))
# fix disease names (a little)
# actually better than plotting colored lines as a time series plot would do
plot(w1ts, type="l", main="Incidences", ylim = c(0, 7000))
points(x = aok_inc$year, y = aok_inc[ , 7], type="b", pch=19, col="blue")
points(x = aok_inc$year, y = aok_inc[ , 6], type="b", pch=19, col="green")
legend("topright", c("AOK / sick leaves non-infect. gastroent.", 
                     "AOK / sick leaves infectious gastroent.",
                     "RKI / infectious gastroenteritis only"), fill=c("blue", "green", "black") )  

```

With the help of a doctor I found out that at least 80% of the cases have an infectious cause, which means I should see a yearly incidence of well above 10,000 in the RKI's data. The plotted values are much lower. I checked this against the yearly values through the institute's interface and noticed even much lower values (240-560) there. 

I think the reason for the different values is that some incidences are summed up when actually a mean should be calculated. For instance, an incidence of 4 in Region East and 6 in Region North does not mean a combined incidence of 10, but of 5. On the other hand, incidences for diseases and ages should be added. 

I'll start over with separate values for cases and population.

# Univariate Analysis
## Iteration 2
### What is the structure of your dataset?

The dataset contains 99,456 observations of 13 variables. For 777 weeks I have the incidence (as cases per 100,000) of nine not very rare infectious diseases, which are related to gastrointestinal symptoms, for patients grouped by age, gender and region of Germany. Again, the observations have been filled with zeros to help with time series analysis later on. A redundant column for the week of the year has been included. 
The regions are North, East, South and West, all of which contain bigger cities and rural areas. Data with unclear gender was already omitted when downloading the data. The size of the dataset is approximately 6 MB. 

### What is/are the main feature(s) of interest in your dataset?

I'd like to know, when a patient sees a doctor with gastrointestinal symptoms, what are the most likely infectious diseases to check. From a first look, gender does not seem to be very important, but age seems to make a difference. 

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

I assume the region of the patient and the time of the year to be other important factors. My time series plots for validation hinted at these relationships. 

### Did you create any new variables from existing variables in the dataset?

I temporarily created a variable for age with factor levels of equal width.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

As before, I had to combine several files into one. This time though, I shortened the names of factor levels to a fixed length to make use of the automatic grouping of the hts library.

# Univariate Plots Section
## Iteration 3

This time I am going to calculate the incidence by myself, because the data source did not clearly document on which numbers they calculated it and they were not available for questions. First, I try to replicate the last plot:

```{r eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data4}
# Load the Data
####################################################################################
#########  switch to eval = TRUE if you want to read 'raw' files again #############
#########  otherwise see next chunk                                    #############
####################################################################################

#getwd()
#setwd("R Scripts/p4")

# ------------------
# functions for reading case number files

read_bind <- function (region, disease, to_bind) {
  # Reads one csv file and bind it to data from other file
  # Args: 
  #   region, disease - for filename and path
  #   to_bind - optional, data.frame from previous file
  # Returns:
  #   read (and bound) data frame    

  # read tab-delimited CSV containing nuls
  filename <- paste(paste(paste("i3", region,  sep="\\"), disease, sep="\\"), "csv", sep=".")
  rd <- read.delim2(filename, skipNul = T, skip = 1)
  
  rd$disease <- disease
  
  # handle date
  colnames(rd)[1] <- "date"
  year <- substr(rd$date, 1, 4)
  # strptime ignores week number, approximate date by adding days from Jan 1st
  year <- substr(rd$date, 1, 4)
  jan <- as.Date(paste("01/01/", year, sep=""), "%m/%d/%Y")
  # and keep week number for seasonal analysis
  rd$week <- as.integer(substr(rd$date, 8, 9))
  rd$date <- jan + (rd$week - 1) * 7
  # we need a year to join with population data
  year <- as.integer(year)
  rd$pop_year <- ifelse(year %% 2 == 0, year, year - 1)
  
  # handle age, first drop "unknown" age column
  rd <- subset(rd, select = - Unbekannt)
  # reformat age column names
  colnames(rd)[2:ncol(rd)] <- gsub(pattern="\\..*", replacement="",
                                   x=colnames(rd)[2:ncol(rd)])
  # melt age columns
  td <- gather(rd, age, case_count, `A00`:`A80` )
  # convert to int
  td$age <- gsub(pattern="A", replacement="", x=td$age)
  td$age <- as.integer(td$age)
  
  if (missing(to_bind)) {
    return(td)
  }
  jd <- bind_rows(to_bind, td)
  return(jd)
}

read_disease <- function (region) {
  # Reads csv files for all diseases
  # Args: 
  #   region - for filepath
  # Returns:
  #   read data frame with diseases as columns 
  
  # handle files for the diseases
  c <- read_bind(region, "camp")
  ec <- read_bind(region, "ecol", c)
  eh <- read_bind(region, "ehec", ec)
  g <- read_bind(region, "giar", eh)
  i <- read_bind(region, "infl", g)
  n <- read_bind(region, "noro", i)
  r <- read_bind(region, "rota", n)
  s <- read_bind(region, "salm", r)
  y <- read_bind(region, "yers", s)
  
  y$disease <- as.factor(y$disease)
  return(y)
}

read_region <- function (region, to_bind) {
  # Reads csv files for one region and bind to data of other region
  # Args: 
  #   region - for filepath
  #   to_bind - optional, data.frame from previous region
  # Returns:
  #   read data frame (bound to previous region)
  
  rd <- read_disease(region)
  # using the same levels as for the population data
  rd$region <- factor(region, pop_levels)
  
  if (missing(to_bind)) {
    return(rd)
  }
  return(bind_rows(to_bind, rd))
}

# ------------------
# read the files and combine into one dataset
rd_north <- read_region("n")
rd_ne <- read_region("e", rd_north)
rd_nes <- read_region("s", rd_ne)
cases <- read_region("w", rd_nes)
remove(rd_north, rd_ne, rd_nes)

cases[is.na(cases)] <- 0.0

write.csv(cases, file="cases.csv", row.names=F)

```

```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data5}
#getwd()
#setwd("R Scripts/p4")
####################################################################################
#########  read data converted above                                   #############
####################################################################################

# load prepared data
cases <- read.csv("cases.csv")
cases$date <- ymd(cases$date)
pop_levels <- levels(cases$region)
cases <- arrange(cases, date)

# ------------------
# read population data
population <- read.csv2("population.csv")

population <- population %>%
  # sum by region 
  mutate(n = Bremen + Hamburg + Mecklenburg.Vorpommern + Niedersachsen +
                       Schleswig.Holstein) %>%
  mutate(e = Berlin + Brandenburg + Sachsen + Sachsen.Anhalt + Thüringen) %>%
  mutate(s = Baden.Württemberg + Bayern) %>%
  mutate(w = Hessen + Nordrhein.Westfalen + Rheinland.Pfalz + Saarland) %>%
  # only need the year, using population of e.g. 31/12/2000 for the years 2000 and 2001
  mutate(year = as.integer(substr(as.character(population$date), 7, 10))) %>%
  # only keep relevant columns
  dplyr::select(year, age, n, e , s, w) %>%
  # handle age
  mutate(age = as.character(age)) %>%
  # remove sum rows
  filter(age != "Insgesamt") %>%
  # prepare conversion to int
  mutate(age = gsub(pattern="\\-.*", replacement="", x=age)) %>%
  mutate(age = gsub(pattern=" Jahre und mehr", replacement="", x=age)) %>%
  mutate(age = gsub(pattern="unter 1 Jahr", replacement="0", x=age)) %>%
  mutate(age = as.integer(age)) 
         
# disease data only has the sum for people 80+, sum
summed <- population %>%
  filter(age >= 80) %>%
  group_by(year) %>%
  summarize_each(funs(sum), n, e , s, w) %>%
  mutate(age = 80)

population <- population %>%
  # replace
  filter(age < 80) %>%
  bind_rows(summed) %>%
  arrange(year) %>%
  # melt regions
  gather(region, pop_count, n:w) %>%
  mutate(region = factor(region, pop_levels))
  
remove(summed)

```


```{r echo=FALSE, fig.width=10, fig.height=5, Univariate_Plots11}

calc_inc <- function (case_count, pop_count) {
  # Calculates incidence as cases per 100,000
  # Args: 
  #   case_count - the case count
  #   pop_count - the population count
  # Returns:
  #   incidence, rounded to .1
  return(round(case_count * 100000 / pop_count, digits = 2))
} 

inc_by_year <- cases %>%
  mutate(date = year(date)) %>%
  # first sum over all weeks and diseases
  group_by(date, pop_year, age, region) %>%
  summarise(annual_dis_cases = sum(case_count)) %>%
  # second join with population data
  left_join(population, by = c("pop_year" = "year", "age" = "age", "region" = "region")) %>%
  dplyr::select(- pop_year) %>%
  # third sum over ages and regions
  group_by(date) %>%
  summarise(annual_cases = sum(annual_dis_cases), annual_pop=sum(pop_count)) %>%
  # fourth calculate incidence
  mutate(incidence = calc_inc(annual_cases, annual_pop))

plot(inc_by_year$date, inc_by_year$incidence, type="l", main="Incidences", ylim = c(0, 7000))
points(x = aok_inc$year, y = aok_inc[ , 7], type="b", pch=19, col="blue")
points(x = aok_inc$year, y = aok_inc[ , 6], type="b", pch=19, col="green")
legend("topright", c("AOK / sick leaves non-infect. gastroent.", 
                     "AOK / sick leaves infectious gastroent.",
                     "RKI / infectious gastroenteritis only"), fill=c("blue", "green", "black") ) 

remove(aok_inc)
str(cases)
```

The numbers now match the values I got from the data source. In a perfect world, the green and black lines would be much higher than the blue line.

This also means that I have to check the values of other plots I consider for my final plots. Here is the update for the long-term trends of diseases:

```{r echo=FALSE, fig.width=10, fig.height=7, Univariate_Plots11a}

annual_pop <- population %>%
  # population number over all ages
  group_by(year) %>%
  summarize(pop = sum(pop_count))

inc_by_quarter_and_dis <- cases %>%
  mutate(date = quarter(date, with_year = TRUE)) %>%
  # first sum over all weeks, ages, regions
  group_by(date, pop_year, disease) %>%
  summarise(annual_cases = sum(case_count)) %>%
  # second join with population data
  left_join(annual_pop, by = c("pop_year" = "year")) %>%
  # third calculate incidence
  mutate(incidence = calc_inc(annual_cases, pop)) %>%
  ungroup() %>%
  mutate(disease = as.character(disease)) %>%
  dplyr::select(date, disease, incidence)
  
# convert to time series 
wide_inc_by_q_and_dis <- dcast(inc_by_quarter_and_dis, date ~ disease)
ts_by_q_and_dis <- ts(subset(wide_inc_by_q_and_dis, select=-date), 
                           frequency = 4, 
                           start = 2001)
plot(ts_by_q_and_dis, type="b", main="Quarterly Incidences")

remove(inc_by_quarter_and_dis)

```

I'd like to try out some forecasting models. I start with the package hts and use a TBATS model from packgage forecast. This model uses spectral analysis and exponential smoothing to fit the time series. 

```{r echo=FALSE, fig.width=10, fig.height=5, Univariate_Plots12}

weekly_inc_by_dis <- cases %>%
  filter(disease %in% c("noro", "rota", "camp", "salm", "infl")) %>%
  # interested in date only
  dplyr::select( - week) %>%
  # sum over ages and regions
  group_by(date, pop_year, disease) %>%
  summarise(week_cases = sum(case_count)) %>%
  left_join(annual_pop, by = c("pop_year" = "year")) %>%
  # mean over pop_years, alternatively could have joined with averaged pop data
  group_by(date, disease) %>%
  summarise(mean_wk_cases = mean(week_cases), mean_pop = mean(pop)) %>%
  mutate(incidence = calc_inc(mean_wk_cases, mean_pop)) %>%
  ungroup() %>%
  dplyr::select(- starts_with("mean")) %>%
  # need wide format for time series
  dcast(date ~ disease) %>%
  dplyr::select( - date)

# create grouped time series                          
gts_weekly_by_dis <- gts(ts(weekly_inc_by_dis, frequency = 53, start = 2001))
# forecast and plot from hts
fc <- forecast(gts_weekly_by_dis, h = 200, method = "bu",
                  keep.fitted = T, keep.resid = T,
                  FUN = function(x) tbats(x))
plot(fc, level=c(1))
plot(fitted(fc))
original <- aggts(fc, forecasts = F, level= c(1))
plot.ts(original)
```

Next is package season, with which I fit a non-stationary cosinor model (sinusoid smoothing) to norovirus only. 

```{r echo=FALSE, fig.width=10, fig.height=5, Univariate_Plots12a}

weekly_inc_noro <- cases %>%
  filter(disease %in% c("noro")) %>%
  # special date format required for nscosinor
  mutate(month = month(date)) %>%
  mutate(year = year(date)) %>%
  dplyr::select(- date) %>%
  # sum over ages and regions
  group_by(year, month, week, pop_year, disease) %>%
  summarise(week_cases = sum(case_count)) %>%
  left_join(annual_pop, by = c("pop_year" = "year")) %>%
  # mean over pop_years, alternatively could have joined with averaged pop data
  group_by(year, month, week, disease) %>%
  summarise(mean_wk_cases = mean(week_cases), mean_pop = mean(pop)) %>%
  mutate(incidence = calc_inc(mean_wk_cases, mean_pop)) %>%
  dplyr::select(year, month, week, disease, incidence) %>%
  ungroup()

# somehow this makes it work....
weekly_inc_noro1 <- data.frame(weekly_inc_noro)
# very few iterations 
nsc <- nscosinor(data = weekly_inc_noro1, response = "incidence", 
          cycles = c(52), niters=100, burnin=50, 
          tau=c(7,40), lambda=1/52, monthly=F)
# plots twice in knitr
plot(nsc)
```

```{r echo=FALSE, fig.width=10, fig.height=3, Univariate_Plots12b}
plot(nsc$fitted.values$mean)
plot(nsc$residuals)

```

A frequently used library is forecast, which supplied the TBATS model for hts.  

```{r echo=FALSE, fig.width=10, fig.height=5, Univariate_Plots12c}

weekly_noro_ts <- ts(weekly_inc_by_dis$noro, frequency = 53, start = 2001)

tb <- tbats(weekly_noro_ts)
plot(tbats.components(tb))
```

```{r echo=FALSE, fig.width=10, fig.height=3, Univariate_Plots12d}
plot(forecast(tb, h=200))
plot(fitted.values(tb))
plot(tb$errors)

```

The models identify a seasonality, but the forecast confidence interval is rather large. I will stick with a simple plot:

```{r echo=FALSE, fig.width=10, fig.height=5, Univariate_Plots13}

weekly_inc_by_dis <- cases %>%
  filter(disease %in% c("noro", "rota", "camp", "salm", "infl")) %>%
  # interested in week number only
  dplyr::select( - date) %>%
  # sum over ages and regions
  group_by(week, pop_year, disease) %>%
  summarise(week_cases = sum(case_count)) %>%
  left_join(annual_pop, by = c("pop_year" = "year")) %>%
  # mean over pop_years, alternatively could have joined with averaged pop data
  group_by(week, disease) %>%
  summarise(mean_wk_cases = mean(week_cases), mean_pop = mean(pop)) %>%
  mutate(incidence = calc_inc(mean_wk_cases, mean_pop)) %>%
  ungroup() %>%
  dplyr::select(- starts_with("mean"))

ggplot(weekly_inc_by_dis, aes(x = week, y = incidence, fill = disease)) +
  geom_area(position = "identity", colour="black", alpha=0.3, size = 1) +
  scale_x_continuous(limits = c(2, 51), breaks=seq(0, 53, by=5))

```

This is going to be a final plot.

# Univariate Analysis
## Iteration 3
### What is the structure of your dataset?

The dataset consists of two parts. To compute the incidences on my own, I downloaded the population data of the German states from https://www-genesis.destatis.de/genesis/online/link/tabellen/12411-0011 . There are limitations on the size of data you can obtain for free, so it is only biennial. Initially, this first part of the data contained 736 obs. of 18 variables, but I reduced it to 648 obs. of 6 variables by summing values for regions and ages 80+.

The second part contains 2,283,228 observations of 7 variables. For 778 weeks I have the case counts of nine not very rare infectious diseases, which are related to gastrointestinal symptoms, for patients grouped by age and region of Germany. Two redundant columns for the week of the year and the year to match with the population data have been included. The size of this dataset is approximately 80 MB. 

### Did you create any new variables from existing variables in the dataset?

The incidence was calculated, often per plot, to ensure the right case and population counts are matched against each other.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

To give an example, the age was included in the form "6 year olds" or "over 90 year olds" in the population data. I had to extract the numeric value and, because the disease data grouped everyone over 80 together, had to sum all ages above 80. Additionally, I had to sum the values for the various states of Germany to obtain population numbers for the regions.

In terms of unusual distributions, when I look at the quarterly incidences, there is a spike in EHEC diseases and E.Coli drops to 0 in 2015.

# Bivariate Plots Section

First, I revisit the disease distribution by age, only this time incidences are not counted but summed up. 

```{r echo=FALSE, fig.width=10, fig.height=7, warning=FALSE, Bivariate_Plots1}

mean_inc_by_age_dis <- cases %>%
  # first sum over all weeks
  group_by(pop_year, age, region, disease) %>%
  summarise(date_cases = sum(case_count)) %>%
  # second join with population data
  left_join(population, by = c("pop_year" = "year", "age" = "age", "region" = "region")) %>%
  # third sum over regions
  group_by(pop_year, age, disease) %>%
  summarise(region_cases = sum(date_cases), all_pop=sum(pop_count)) %>%
  # fourth mean over years
  group_by(age, disease) %>%
  summarise(annual_cases = mean(region_cases), mean_pop=mean(all_pop)) %>%
  # fifth calculate incidence per 100,000 and round to .1
  mutate(incidence = calc_inc(annual_cases, mean_pop)) %>%
  ungroup()

theme_set(theme_few())

ggplot(mean_inc_by_age_dis, aes(x = age, y = incidence, fill = disease)) +
  geom_area(stat = "identity", position = "stack", colour="black") +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_continuous(breaks=seq(0, 80, by=5)) 
```

And as a windrose plot:

```{r echo=FALSE, fig.width=10, fig.height=7, warning=FALSE, Bivariate_Plots3}

ggplot(mean_inc_by_age_dis, aes(fill = age, y = incidence, x = disease)) +
  geom_bar(stat = "identity") +
  coord_polar(start = - 2.3 * pi / 4) +
  scale_fill_gradientn(colours = diverge_hcl(81)) + 
  scale_x_discrete(limits = c("infl", "noro", "rota", "camp", "salm", "ecol", "ehec", "giar", "yers"))

```

And finally as dot size representing incidence, vaguely reminding of a violin plot:

```{r echo=FALSE, fig.width=10, fig.height=7, warning=FALSE, Bivariate_Plots3a}

ggplot(mean_inc_by_age_dis, aes(x = age, size = incidence, y = disease, colour=disease)) +
  geom_point(stat = "identity", alpha=0.7) +
  scale_colour_manual(values = rainbow_hcl(9)) +
  scale_size_continuous(range=c(0.1, 12)) +
  scale_y_discrete(limits = c("infl", "noro", "rota", "camp", "salm", "ecol", "ehec", "giar", "yers"))

remove(mean_inc_by_age_dis)
```

I think the difference between campylobacter, norovirus and salmonella on the one hand and rotavirus on the other are much clearer if plotted this way. This could be the basis for a final plot.

I had not expected that the differences are that big. Again, I have to consider that the data contains reported cases, maybe adults just do not see a doctor when they have the syptoms. 

All plots show that only 3 to 5 diseases seem to be responsible for the majority of cases, which is also something I wanted to investigate earlier in the univariate section. Here is the variability the monthly incidences of each disease in Germany for all ages.

```{r echo=FALSE, fig.width=10, fig.height=7, Bivariate_Plots4}

monthly_inc <- cases 
# going to sum for months, so set all dates to the first of month
mday(monthly_inc$date) <- 1
monthly_inc <- monthly_inc %>%
  # sum for months over ages and regions
  group_by(date, pop_year, disease) %>%
  summarize(month_cases = sum(case_count)) %>%
  # calculate incidence
  left_join(annual_pop, by = c("pop_year" = "year")) %>%
  mutate(incidence = calc_inc(month_cases, pop))

# boxplot of diseases
qplot(data=monthly_inc, x=disease, y=incidence,
      geom="boxplot", fill=disease, main="Boxplot of Monthly Disease Incidences, Zoomed In") + 
  guides(fill=FALSE) +
  ylim(0, 25)

```

Influenza has a low mean but quite a few outliers, up to 109. Together with the long-term plots from above I conclude that influenza has a rather short season, while rota- and norovirus stay for a longer time of the year.

Next, I'm going to explore how region and disease are related.

```{r echo=FALSE, fig.width=10, fig.height=5, Bivariate_Plots5}

annual_region_pop <- population %>%
  # population numbers for regions over all ages
  group_by(year, region) %>%
  summarize(pop = sum(pop_count)) %>%
  ungroup()

mean_inc_by_reg_dis <- cases %>%
  # first sum over all weeks and ages
  group_by(pop_year, region, disease) %>%
  summarise(biennal_cases = sum(case_count)) %>%
  # second join with population data
  left_join(annual_region_pop, by = c("pop_year" = "year", "region" = "region")) %>%
  # third sum over years
  group_by(region, disease) %>%
  summarise(region_cases = mean(biennal_cases), mean_pop=mean(pop)) %>%
  # fourth calculate incidence per 100,000 and round to .1
  mutate(incidence = calc_inc(region_cases, mean_pop)) 

ggplot(mean_inc_by_reg_dis, aes(fill = disease, y = incidence, x = region)) +
  geom_bar(stat = "identity", colour = "black") +
  coord_polar(start = - pi / 4) +
  scale_fill_manual(values = rainbow_hcl(9)) + 
  scale_x_discrete(limits = c("n", "e", "s", "w"))

ggplot(mean_inc_by_reg_dis, aes(size = incidence, y = disease, x = region, color=disease)) +
  geom_point(stat = "identity") +
  scale_fill_manual(values = rainbow_hcl(9)) + 
  scale_x_discrete(limits = c("n", "e", "s", "w")) + 
  scale_size_continuous(range = c(1, 20)) +
  guides(color = guide_legend(reverse = TRUE))

```

Region East shows higher incidences in both plots, maybe this is caused by an one-time event. Additionally, I can see the regional outbreak of EHEC in the east in 2011.

```{r echo=FALSE, fig.width=10, fig.height=10, Bivariate_Plots6}

monthly_inc <- cases 
# going to sum for months, so set all dates to the first of month
mday(monthly_inc$date) <- 1

monthly_inc_east <- monthly_inc %>%
  filter(region == "e") %>%
  # sum for months over ages
  group_by(date, pop_year, region, disease) %>%
  summarize(month_cases = sum(case_count)) %>%
  # calculate incidence
  left_join(annual_region_pop, by = c("pop_year" = "year", "region" = "region" )) %>%
  mutate(incidence = calc_inc(month_cases, pop)) %>%
  ungroup() %>%
  mutate(disease = as.character(disease)) %>%
  dplyr::select(date, disease, incidence)

monthly_inc_rest <- monthly_inc %>%
  filter(region != "e") %>%
  # sum for months over ages
  group_by(date, pop_year, region, disease) %>%
  summarize(month_cases = sum(case_count)) %>%
  # calculate incidence
  left_join(annual_region_pop, by = c("pop_year" = "year", "region" = "region" )) %>%
  # sum over regions
  group_by(date, disease) %>%
  summarise(rest_cases = sum(month_cases), rest_pop=sum(pop)) %>%
  mutate(incidence = calc_inc(rest_cases, rest_pop)) %>%
  ungroup() %>%
  mutate(disease = as.character(disease)) %>%
  dplyr::select(date, disease, incidence)

p1 <- ggplot(monthly_inc_east, aes(x = date, y = incidence, fill = disease),  title = "Monthly Incidences in Region East") +
  geom_area(position = "identity", alpha=.2, colour="black", size=.7) +
  ylim(0, 120) + 
  guides(fill=FALSE)

p2 <- ggplot(monthly_inc_rest, aes(x = date, y = incidence, fill = disease), main = "Monthly Incidences in Other Regions") +
  geom_area(position = "identity", alpha=.2, colour="black", size=.7) +
  ylim(0, 120) +
  guides(fill=FALSE)

monthly_inc_diff <- monthly_inc_east %>%
  # calculate diff
  left_join(monthly_inc_rest, by = c("date" = "date", "disease" = "disease")) %>%
  mutate(incidence = incidence.x - incidence.y) 

p3 <- ggplot(data = monthly_inc_diff, aes(x = date, y = incidence, fill = disease), main = "Difference between Monthly Incidences") +
  geom_area(position = "identity", alpha=.2, colour="black", size=.7) +
  ylim(-15, 70) +
  theme(legend.position = "bottom")

grid.arrange(p1, p2, p3)

remove(monthly_inc, monthly_inc_rest, monthly_inc_east, monthly_inc_diff)
```

The upper plots show incidences in the east and the rest, the lower plot the difference between them. Region East has higher incidences for all diseases in almost every single month. Are doctors there more eager to report or is this caused by the age structure?

```{r echo=FALSE, fig.width=10, fig.height=3, Bivariate_Plots7}

pop_east_rest <- population %>%
  filter(year == 2014) %>%
  dplyr::select( - year) %>%
  dcast(age ~ region) %>%
  mutate(rest = n + s + w) %>%
  dplyr::select(age, e, rest) %>%
  mutate(e = e * 1000 / sum(e), rest = rest * 1000 / sum(rest)) %>%
  mutate(rel_diff = (e - rest) * 200 / (e+rest)) %>%
  gather(region, pop_prop, e, rest)

ggplot(pop_east_rest, aes(x = age, size = pop_prop, y = region, colour=rel_diff)) +
  geom_point(stat = "identity", alpha=0.9) +
  scale_colour_gradientn(colours = diverge_hcl(12)) +
  scale_size_continuous(range=c(0.1, 10)) +
  scale_y_discrete(limits = rev(c("e", "rest"))) 

```

The size of the dots shows what proportion the different ages have within the east and the rest, while color indicates how big the difference between the regions is. The East has relatively fewer people around 20, and more people 60+. The difference in small kids is relatively low, though, and I should not forget that I am comparing incidences as cases per 100,000 already. 

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

I saw that there are seasonal patterns in the incidences of some diseases. The incidence is also influenced by the age of the patient. One region, East, has higher incidences in general.

In a side exploration with incidence from another source it became clear that the aspect of reporting behavior is important, but beyond the scope of the data set.

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

The age structure of the East and the rest of Germany is different, the consequence of which is hopefully going to be explained in the next section. 

### What was the strongest relationship you found?

I think the time of the year has the strongest influence on incidence, but I am not sure if I can quantify that. 

# Multivariate Plots Section

```{r echo=FALSE, fig.width=10, fig.height=10, Multivariate_Plots}

theme_set(theme_few())

annual_age_pop <- population %>%
  # population numbers for all ages
  group_by(year, age) %>%
  summarize(pop = sum(pop_count)) %>%
  ungroup()

inc_by_age_reg_dis <- cases %>%
  mutate(date = year(date)) %>%
  dplyr::select( - week) %>%
  # cases per year, age. disease and region
  group_by(date, pop_year, age, disease, region) %>%
  summarise(annual_reg_cases = sum(case_count)) %>%
  left_join(population, by=c("pop_year" = "year", "age" = "age", 
                                    "region" = "region")) %>%
  mutate(reg_inc = calc_inc(annual_reg_cases, pop_count)) %>%
  # cases per year, age and disease
  ungroup() %>%
  dplyr::select( - pop_count) %>%
  group_by(date, pop_year, age, disease) %>%
  mutate(annual_cases = sum(annual_reg_cases)) %>%
  left_join(annual_age_pop, by=c("pop_year" = "year", "age" = "age")) %>%
  mutate(incidence = calc_inc(annual_cases, pop)) %>%
  ungroup() %>%
  dplyr::select(- annual_cases, - annual_reg_cases, - pop, - pop_year) %>%
  # difference to mean 
  mutate(rel_diff = ifelse(incidence > 0, 
                           as.integer((reg_inc - incidence) * 100 / incidence), 
                           0)) %>%
  # only region of max difference 
  group_by(date, age, disease) %>%
  mutate(top_reg = max(rel_diff)) %>%
  ungroup() %>%
  filter(rel_diff == top_reg) %>%
  dplyr::select( - top_reg) 
  
ggplot(inc_by_age_reg_dis, aes(x = age, size = rel_diff, y = disease, colour=region)) +
  geom_point(stat = "identity", position = position_jitter(width=0.3, height=1.1), alpha = 0.25) +
  scale_colour_manual(values = rainbow_hcl(4)) +
  scale_size_area(max_size = 7)
  
remove(inc_by_age_reg_dis)

```

The plot shows the relative difference of incidences (in percent, size of dots) for the diseases and various ages. There is one dot in the color of the region with the highest deviation from the mean for every year from 2001 to 2015. 

For rotavirus, there is a rather big deviation for all ages and years in region East. For almost all diseases, region East deviates most for people under 18. Historically, there was a much more centralised healthcare in the East, which might still influence the tendency of doctors to report cases. There are more patterns in the plot, for which I do not have a potential explanation.

After the exploration of age/ region/ disease is exhausted, I will have a look at the seasonality again. 

```{r echo=FALSE, fig.width=10, fig.height=8, Multivariate_Plots2}

inc_by_dis <- cases %>%
  filter(disease %in% c("noro", "rota", "camp", "salm", "infl")) %>%
  # interested in year and week number only
  mutate(year = year(date)) %>%
  dplyr::select( - date) %>%
  # sum over ages and regions
  group_by(year, week, pop_year, disease) %>%
  summarise(annual_week_cases = sum(case_count)) %>%
  left_join(annual_pop, by = c("pop_year" = "year")) %>%
  mutate(incidence = calc_inc(annual_week_cases, pop)) %>%
  ungroup() %>%
  # discard error-prone weeks
  filter(week > 1 & week < 52) %>%
  dplyr::select(year, week, disease, incidence)

pl <- function (disease) {
  # Plots incidence for one disease.
  # Necessary because faceting cannot scale the fill freely.
  data <- inc_by_dis[inc_by_dis$disease == disease, ]
  ggplot(data, aes(x = year, y = week, fill=incidence)) +
    geom_raster() +
    scale_fill_gradientn(colours = heat_hcl(20)) +
    ggtitle(disease)
}

p1 <- pl("camp")
p2 <- pl("noro")
p3 <- pl("salm")
p4 <- pl("rota")
p5 <- pl("infl")

grid.arrange(p1, p2, p3, p4, p5)
remove(inc_by_dis, p1, p2, p3, p4, p5)
```

The seasonality, which showed in the plot of the annual means above, is still there, but there are some changes over time. When I forecast noro- or rotavirus later, I will limit the data to years from 2008. 

Norovirus has high incidences in small kids and older people. Maybe the seasonality varies with age for norovirus.

```{r echo=FALSE, fig.width=10, fig.height=10, Multivariate_Plots3}

inc_norocamp_age_dis <- cases %>%
  filter(disease %in% c("noro", "camp")) %>%
  # interested in year and week number only
  mutate(year = year(date)) %>%
  dplyr::select( - date) %>%
  # sum over regions
  group_by(disease, year, week, pop_year, age) %>%
  summarise(annual_age_week_cases = sum(case_count)) %>%
  left_join(annual_age_pop, by = c("pop_year" = "year", "age" = "age")) %>%
  mutate(incidence = calc_inc(annual_age_week_cases, pop)) %>%
  ungroup() %>%
  # discard error-prone weeks
  filter(week > 1 & week < 52) %>%
  dplyr::select(disease, year, week, age, incidence)

pl <- function (age, disease) {
  # Plots incidence of one age and disease.
  # Necessary because faceting cannot scale the fill freely.
  data <- inc_norocamp_age_dis[inc_norocamp_age_dis$age == age & 
                             inc_norocamp_age_dis$disease == disease, ]
  ggplot(data, aes(x = year, y = week, fill=incidence)) +
    geom_raster() +
    scale_fill_gradientn(colours = heat_hcl(30)) +
    ggtitle(paste(disease, age, sep=":"))
}

pld <- function (disease) {
  # Plots incidence of various ages for one disease.
  # Necessary because faceting cannot scale the fill freely.
  p1 <- pl(0, disease)
  p2 <- pl(1, disease)
  p3 <- pl(2, disease)
  p4 <- pl(3, disease)
  p9 <- pl(18, disease)
  p10 <- pl(20, disease)
  p11 <- pl(25, disease)
  p12 <- pl(30, disease)
  p5 <- pl(77, disease)
  p6 <- pl(78, disease)
  p7 <- pl(79, disease)
  p8 <- pl(80, disease)
  grid.arrange(p1, p9, p5, p2, p10, p6, p3, p11, p7, p4, p12, p8, ncol = 3)
}

pld("noro")
```

What is the pattern for campylobacter?

```{r echo=FALSE, fig.width=10, fig.height=10, Multivariate_Plots3a}
pld("camp")

remove(inc_norocamp_age_dis)
```

While the seasonal pattern is similar within the age groups (columns), it looks different between the groups for norovirus. I will consider that in the final version of the seasonality plot.

Before I try a forecast, I have a look at the seasonality of some diseases by ages and regions:

```{r echo=FALSE, fig.width=10, fig.height=5, Multivariate_Plots4}

inc_by_age_wk_dis <- cases %>%
  #filter(disease %in% c("noro", "rota", "camp", "salm", "infl")) %>%
  # interested in year and week number only
  mutate(year = year(date)) %>%
  dplyr::select( - date) %>%
  # only years from 2008
  filter(year > 2007) %>%
  left_join(annual_region_pop, by = c("pop_year" = "year", "region" = "region")) %>%
  # mean over years
  dplyr::select( - pop_year) %>%
  group_by(week, region, disease, age) %>%
  summarise(mean_wk_cases = mean(case_count), mean_reg_pop = mean(pop)) %>%
  mutate(incidence = calc_inc(mean_wk_cases, mean_reg_pop)) %>%
  ungroup() %>%
  # discard error-prone weeks
  filter(week > 1 & week < 52) %>%
  dplyr::select(age, week, disease, region, incidence)

pl <- function (region, disease, transform) {
  # Plots incidence of one region and disease with a trasformation of incidence.
  # Necessary because faceting cannot scale the fill freely.
  data <- inc_by_age_wk_dis[inc_by_age_wk_dis$disease == disease &
                              inc_by_age_wk_dis$region == region, ]
  FUN <- get(transform, envir = baseenv())
  ggplot(data, aes(x = age, y = week, fill=FUN(incidence), z = FUN(incidence))) +
    geom_raster() +
    scale_fill_gradientn(colours = heat_hcl(30)) +
    ggtitle(paste(transform, paste(disease, region, sep=":"), sep=":")) 
}

plr <- function (disease, transform) {
  # Plots incidence of all regions for one disease with a trasformation of incidence.
  # Necessary because faceting cannot scale the fill freely.
  p1 <- pl("n", disease, transform)
  p2 <- pl("e", disease, transform)
  p3 <- pl("w", disease, transform)
  p4 <- pl("s", disease, transform)
  grid.arrange(p1, p2, p3, p4, ncol = 2)
}

plr("noro", "log")
plr("rota", "log")
plr("camp", "identity")

remove(inc_by_age_wk_dis)
```

There is no real difference between the regions. The diseases seem to hit all ages at once within the season.

With the new insights I try to forecast some incidences again:

```{r echo=FALSE, fig.width=10, fig.height=4, Multivariate_Plots5}

weekly_inc_by_dis_ag <- cases %>%
  filter(disease %in% c("noro", "rota", "camp", "salm", "infl")) %>%
  filter(year(date) > 2007) %>%
  # discard error-prone weeks
  filter(week > 1 & week < 52) %>%
  # interested in date only
  dplyr::select( - week) %>%
  # sum over regions
  group_by(date, pop_year, disease, age) %>%
  summarise(week_cases = sum(case_count)) %>%
  left_join(annual_age_pop, by = c("pop_year" = "year", "age" = "age")) %>%
  # filter for very young, young and older people
  mutate(age_group = ifelse(age < 7, "y", 
                            ifelse(age > 17 & age < 26, "m",
                                   ifelse(age > 74, "o", "other")))) %>%
  filter(age_group != "other") %>%
  ungroup() %>%
  dplyr::select( - age, - pop_year) %>%
  # calculate incidence for age group and disease
  group_by(date, disease, age_group) %>%
  summarise(group_wk_cases = sum(week_cases), group_pop = sum(pop)) %>%
  mutate(incidence = calc_inc(group_wk_cases, group_pop)) %>%
  ungroup() %>%
  dplyr::select(- starts_with("group")) %>%
  # need wide format for time series
  dcast(date ~ age_group + disease) 

weekly_inc_dis_ag_to13 <- weekly_inc_by_dis_ag %>%
  filter(year(date) < 2014) %>%
  dplyr::select( - date)

weekly_inc_dis_ag_fr13 <- weekly_inc_by_dis_ag %>%
  filter(year(date) > 2013) %>%
  dplyr::select( - date)

remove(weekly_inc_by_dis_ag)

tb <- function (disease) {
  # Plots forecast for a disease
  fit <- tbats(ts(weekly_inc_dis_ag_to13[ , disease], frequency = 50, start = 2008), 
              num.cores=NULL)
  fc <- forecast(fit, h=100, level=c(50))
  fitres <- fortify(fit$errors)   
  actual <- fortify(ts(weekly_inc_dis_ag_fr13[ , disease], 
                       frequency = 50, start = 2014))
  autoplot(fc, conf.int.colour = "lightgray", 
           predict.size = .75, ts.size = .75, 
           predict.colour = "black", predict.linetype = 5, 
           main = disease) + 
    scale_x_continuous(breaks = c(2008, 2010, 2012, 2014, 2016, 2018, 2020)) +
    geom_line(data = fitres, aes(x = Index, y = Data), size = 0.1) +
    geom_line(data = actual, aes(x = Index, y = Data), size = 0.5, 
              colour = "red") 

}
   
tb("y_noro")
tb("o_noro")

tb("y_camp")
tb("m_camp")

tb("y_rota")

```

The thick black and the thin red line are the actual incidence of a disease and age group. The dashed line is the forecast with a .5 confidence interval. The thin black line shows the residuals of the model.



# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection
